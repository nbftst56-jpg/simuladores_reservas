<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gerenciador de Tarifas de Hospedagem v2.2</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <style>
    body {
      background-color: #f8f9fa;
    }
    .container {
      margin-top: 2rem;
      margin-bottom: 2rem;
    }
    .card {
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    #tabelaValores th {
      cursor: pointer;
    }
    td[contenteditable="true"] {
      background-color: #fffbe6;
    }
    .form-control.error {
      border-color: #dc3545;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="text-center mb-4">
      <h1 class="display-5">üìä Gerenciador de Tarifas de Hospedagem</h1>
    </div>

    <div class="row g-5">
      <div class="col-lg-5">
        <div class="card">
          <div class="card-header">
            <h3><i class="bi bi-person-lines-fill"></i> Informa√ß√µes do Cliente</h3>
          </div>
          <div class="card-body">
            <div id="form">
              <div class="mb-3">
                <label for="nome" class="form-label">Nome *</label>
                <input type="text" id="nome" class="form-control" />
              </div>
              <div class="mb-3">
                <label for="contato" class="form-label">Contato (com c√≥digo do pa√≠s/DDD) *</label>
                <input type="text" id="contato" class="form-control" placeholder="Ex: 5548999998888" />
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="checkin" class="form-label">Check-in *</label>
                  <input type="date" id="checkin" class="form-control" />
                </div>
                <div class="col-md-6 mb-3">
                  <label for="checkout" class="form-label">Check-out *</label>
                  <input type="date" id="checkout" class="form-control" />
                </div>
              </div>
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label for="pessoas" class="form-label">N¬∫ Pessoas *</label>
                  <input type="number" id="pessoas" class="form-control" min="1" value="1"/>
                </div>
                <div class="col-md-4 mb-3">
                  <label for="desconto" class="form-label">Desconto (%)</label>
                  <input type="number" id="desconto" class="form-control" min="0" max="100" value="0"/>
                </div>
                <div class="col-md-4 mb-3">
                  <label for="sinal" class="form-label">Sinal (%)</label>
                  <input type="number" id="sinal" class="form-control" min="0" max="100" value="0"/>
                </div>
              </div>
            </div>
            
            <hr>
            <h5><i class="bi bi-plus-circle-dotted"></i> Taxas Adicionais</h5>
            <div id="taxasAdicionaisContainer">
            </div>
            <button id="adicionarTaxaBtn" class="btn btn-sm btn-outline-primary mt-2">
              <i class="bi bi-plus-lg"></i> Adicionar Taxa
            </button>

            <div class="d-grid gap-2 mt-4">
              <button id="calcularBtn" class="btn btn-primary btn-lg"><i class="bi bi-calculator"></i> Calcular Or√ßamento</button>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-7">
        <div class="card">
          <div class="card-header">
             <div class="d-flex justify-content-between align-items-center">
                <h3><i class="bi bi-calendar3-week"></i> Tabela de Tarifas</h3>
                <span id="statusSalvo" class="badge bg-success" style="display: none;">Salvo!</span>
            </div>
          </div>
          <div class="card-body">
            <div id="filtros" class="row g-2 mb-3 align-items-center">
              <div class="col-md-3">
                <select id="filtroTipo" class="form-select">
                  <option value="Todos">Todos os Tipos</option>
                  <option>Promo√ß√£o</option>
                  <option>M√©dia</option>
                  <option>Alta</option>
                  <option>Baixa</option>
                  <option>Pacote Esp</option>
                </select>
              </div>
              <div class="col-md-3">
                <input type="date" id="fromDate" class="form-control" title="Data In√≠cio"/>
              </div>
              <div class="col-md-3">
                <input type="date" id="toDate" class="form-control" title="Data Fim"/>
              </div>
              <div class="col-md-3 d-flex">
                  <button id="aplicarFiltroBtn" class="btn btn-secondary me-2" title="Aplicar Filtro"><i class="bi bi-funnel-fill"></i></button>
                  <button id="limparFiltroBtn" class="btn btn-outline-secondary" title="Limpar Filtro"><i class="bi bi-x-lg"></i></button>
              </div>
            </div>

            <div class="table-responsive">
              <table id="tabelaValores" class="table table-striped table-hover">
                <thead class="table-dark">
                  <tr>
                    <th data-col="0">In√≠cio</th>
                    <th data-col="1">Fim</th>
                    <th data-col="2">Pre√ßo BRL</th>
                    <th data-col="3">Pre√ßo USD</th>
                    <th data-col="4">M√≠n. Noites</th>
                    <th data-col="5">Tipo</th>
                    <th data-col="6">Observa√ß√µes</th>
                    <th>A√ß√µes</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td contenteditable="true">15/11/2025</td><td contenteditable="true">30/11/2025</td><td contenteditable="true">400</td><td contenteditable="true">80</td><td contenteditable="true">3</td><td contenteditable="true">Promo√ß√£o</td><td contenteditable="true">In√≠cio de temporada</td></tr>
                  <tr><td contenteditable="true">01/12/2025</td><td contenteditable="true">20/12/2025</td><td contenteditable="true">450</td><td contenteditable="true">90</td><td contenteditable="true">3</td><td contenteditable="true">M√©dia</td><td contenteditable="true">Pr√© Natal</td></tr>
                  <tr><td contenteditable="true">21/12/2025</td><td contenteditable="true">28/12/2025</td><td contenteditable="true">600</td><td contenteditable="true">120</td><td contenteditable="true">5</td><td contenteditable="true">Alta</td><td contenteditable="true">Natal - R√©veillon</td></tr>
                  <tr><td contenteditable="true">29/12/2025</td><td contenteditable="true">02/01/2026</td><td contenteditable="true">850</td><td contenteditable="true">170</td><td contenteditable="true">5</td><td contenteditable="true">Pacote Esp</td><td contenteditable="true">R√©veillon</td></tr>
                  <tr><td contenteditable="true">03/01/2026</td><td contenteditable="true">31/01/2026</td><td contenteditable="true">650</td><td contenteditable="true">130</td><td contenteditable="true">4</td><td contenteditable="true">Alta</td><td contenteditable="true">Alta temporada Jan</td></tr>
                  <tr><td contenteditable="true">01/02/2026</td><td contenteditable="true">09/02/2026</td><td contenteditable="true">750</td><td contenteditable="true">150</td><td contenteditable="true">5</td><td contenteditable="true">Alta</td><td contenteditable="true">Alta temporada Fev</td></tr>
                  <tr><td contenteditable="true">10/02/2026</td><td contenteditable="true">17/02/2026</td><td contenteditable="true">750</td><td contenteditable="true">150</td><td contenteditable="true">5</td><td contenteditable="true">Pacote Esp</td><td contenteditable="true">Carnaval</td></tr>
                  <tr><td contenteditable="true">18/02/2026</td><td contenteditable="true">28/02/2026</td><td contenteditable="true">650</td><td contenteditable="true">130</td><td contenteditable="true">5</td><td contenteditable="true">M√©dia</td><td contenteditable="true">M√©dia Temporada Fev</td></tr>
                  <tr><td contenteditable="true">01/03/2026</td><td contenteditable="true">15/03/2026</td><td contenteditable="true">500</td><td contenteditable="true">100</td><td contenteditable="true">3</td><td contenteditable="true">M√©dia</td><td contenteditable="true">M√©dia Temporada Mar</td></tr>
                  <tr><td contenteditable="true">16/03/2026</td><td contenteditable="true">30/04/2026</td><td contenteditable="true">400</td><td contenteditable="true">80</td><td contenteditable="true">3</td><td contenteditable="true">Baixa</td><td contenteditable="true">Fim da temporada</td></tr>
                </tbody>
              </table>
            </div>
             <button id="adicionarLinhaBtn" class="btn btn-success me-2"><i class="bi bi-plus-square"></i> Adicionar Linha</button>
             <button id="exportarJsonBtn" class="btn btn-info me-2"><i class="bi bi-box-arrow-up"></i> Exportar JSON</button>
             <input type="file" id="importarJsonInput" accept=".json" style="display:none;" />
             <button id="importarJsonBtn" class="btn btn-info"><i class="bi bi-box-arrow-in-down"></i> Importar JSON</button>
          </div>
        </div>
      </div>
    </div>
    
    <div id="relatorioContainer" class="mt-5">
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    let propostaAtual = {}; // Vari√°vel para guardar os dados do √∫ltimo c√°lculo

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('adicionarTaxaBtn').addEventListener('click', () => {
            const container = document.getElementById('taxasAdicionaisContainer');
            const newTaxaId = 'taxa_' + Date.now();
            
            const div = document.createElement('div');
            div.className = 'input-group mb-2';
            div.id = newTaxaId;
            
            div.innerHTML = `
                <input type="text" class="form-control" placeholder="Descri√ß√£o da Taxa (ex: Limpeza)">
                <input type="number" class="form-control" placeholder="Valor (R$)" min="0" value="0">
                <button class="btn btn-outline-danger" onclick="document.getElementById('${newTaxaId}').remove()">
                    <i class="bi bi-trash"></i>
                </button>
            `;
            container.appendChild(div);
        });

        const popularTabela = (dados) => {
            const tabela = document.querySelector('#tabelaValores tbody');
            tabela.innerHTML = '';
            dados.forEach(campo => {
                const tr = document.createElement('tr');
                campo.forEach(valor => {
                    const td = document.createElement('td');
                    td.contentEditable = true;
                    td.textContent = valor;
                    tr.appendChild(td);
                });
                const tdRemover = document.createElement('td');
                const btnRemover = document.createElement('button');
                btnRemover.className = 'btn btn-sm btn-danger';
                btnRemover.innerHTML = '<i class="bi bi-trash"></i>';
                btnRemover.title = 'Remover linha';
                btnRemover.addEventListener('click', () => {
                    tr.remove();
                    salvarTabelaLocal();
                });
                tdRemover.appendChild(btnRemover);
                tr.appendChild(tdRemover);
                tabela.appendChild(tr);
            });
        };

        const dadosSalvos = localStorage.getItem('tabelaValores');
        if (dadosSalvos) {
            popularTabela(JSON.parse(dadosSalvos));
        } else {
            const linhasIniciais = Array.from(document.querySelectorAll('#tabelaValores tbody tr'));
            const dadosIniciais = linhasIniciais.map(tr => Array.from(tr.cells).map(td => td.textContent));
            popularTabela(dadosIniciais);
        }

        document.querySelector('#tabelaValores tbody').addEventListener('input', salvarTabelaLocal);

        ['nome','contato','checkin','checkout','pessoas'].forEach(id => {
            const el = document.getElementById(id);
            el.addEventListener('input', () => el.classList.remove('error'));
        });

        document.querySelectorAll('#tabelaValores th').forEach(th => {
            if(th.dataset.col) th.addEventListener('click', () => sortTable(parseInt(th.dataset.col)));
        });

        document.getElementById('aplicarFiltroBtn').addEventListener('click', aplicarFiltro);
        document.getElementById('limparFiltroBtn').addEventListener('click', () => {
            document.getElementById('filtroTipo').value = 'Todos';
            document.getElementById('fromDate').value = '';
            document.getElementById('toDate').value = '';
            aplicarFiltro();
        });

        document.getElementById('calcularBtn').addEventListener('click', calcular);
        document.getElementById('adicionarLinhaBtn').addEventListener('click', adicionarLinha);
        document.getElementById('exportarJsonBtn').addEventListener('click', exportarJson);
        document.getElementById('importarJsonBtn').addEventListener('click', () => document.getElementById('importarJsonInput').click());
        document.getElementById('importarJsonInput').addEventListener('change', importarJson);
    });

    function parseDateDMY(str) {
      if (!str || !str.includes('/')) return null;
      const [d,m,y] = str.split('/');
      const date = new Date(+y, +m-1, +d);
      return isNaN(date) ? null : date;
    }
    
    async function obterCotacoes() {
      try {
        const res  = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
        const json = await res.json();
        return {
            BRL: json.rates.BRL || 5.00,
            ARS: json.rates.ARS || 900.00
        };
      } catch {
        return { BRL: 5.00, ARS: 900.00 };
      }
    }

    function sortTable(colIdx) {
      const tbl = document.getElementById('tabelaValores');
      const tbody = tbl.tBodies[0];
      let rows = Array.from(tbody.rows);
      const asc = tbl.getAttribute('data-sort-col') != colIdx || tbl.getAttribute('data-sort-order') === 'desc';
      
      rows.sort((a,b) => {
        let va = a.cells[colIdx].textContent.trim();
        let vb = b.cells[colIdx].textContent.trim();
        
        let da = colIdx === 0 || colIdx === 1 ? parseDateDMY(va) : NaN;
        let db = colIdx === 0 || colIdx === 1 ? parseDateDMY(vb) : NaN;

        va = !isNaN(da) && da !== null ? da.getTime() : (isNaN(+va) ? va.toLowerCase() : +va);
        vb = !isNaN(db) && db !== null ? db.getTime() : (isNaN(+vb) ? vb.toLowerCase() : +vb);

        if (va > vb) return asc ? 1 : -1;
        if (va < vb) return asc ? -1 : 1;
        return 0;
      });

      rows.forEach(r => tbody.appendChild(r));
      tbl.setAttribute('data-sort-col', colIdx);
      tbl.setAttribute('data-sort-order', asc?'asc':'desc');
    }

    function aplicarFiltro() {
      const tipo = document.getElementById('filtroTipo').value;
      const from = document.getElementById('fromDate').valueAsDate;
      const to   = document.getElementById('toDate').valueAsDate;
      
      document.querySelectorAll('#tabelaValores tbody tr').forEach(tr => {
        let okTipo = (tipo === 'Todos' || tr.cells[5].textContent === tipo);
        let ini = parseDateDMY(tr.cells[0].textContent);
        let fim = parseDateDMY(tr.cells[1].textContent);
        let okDate = true;
        
        if (!ini || !fim) {
            okDate = false;
        } else {
            if (from) okDate = okDate && fim >= from;
            if (to)   okDate = okDate && ini <= to;
        }

        tr.style.display = (okTipo && okDate) ? '' : 'none';
      });
    }

    async function calcular() {
      let hasError = false;
      const requiredFields = ['nome','contato','checkin','checkout','pessoas'];
      requiredFields.forEach(id => {
          const el = document.getElementById(id);
          if (!el.value) {
              el.classList.add('error');
              hasError = true;
          }
      });

      if (hasError) {
          alert('Preencha todos os campos obrigat√≥rios (*)');
          return;
      }

      const ci = new Date(document.getElementById('checkin').value);
      const co = new Date(document.getElementById('checkout').value);
      const totalNights = (co - ci)/(1000*60*60*24);

      if (totalNights <= 0) {
        alert('A data de Check-out deve ser posterior √† data de Check-in.');
        return;
      }

      let minNoitesExigido = 0;
      let violacaoMinNoites = false;
      document.querySelectorAll('#tabelaValores tbody tr').forEach(tr => {
        if (tr.style.display === 'none') return;
        const rowStart = parseDateDMY(tr.cells[0].textContent);
        const rowEnd   = parseDateDMY(tr.cells[1].textContent);
        if (!rowStart || !rowEnd) return;
        const start = ci  > rowStart ? ci  : rowStart;
        const end = co  < rowEnd   ? co  : rowEnd;
        const overlap = (end - start)/(1000*60*60*24);
        if (overlap > 0) {
            const noitesDaTabela = parseInt(tr.cells[4].textContent) || 0;
            if (noitesDaTabela > minNoitesExigido) {
                minNoitesExigido = noitesDaTabela;
            }
        }
      });
      if (totalNights < minNoitesExigido) {
          violacaoMinNoites = true;
      }
      if (violacaoMinNoites) {
          const continuar = confirm(`Aten√ß√£o: O per√≠odo selecionado de ${totalNights} noite(s) n√£o atinge o m√≠nimo de ${minNoitesExigido} noite(s) exigido para uma parte da data.\n\nDeseja continuar com o c√°lculo mesmo assim?`);
          if (!continuar) {
              return;
          }
      }

      let weightedSum = 0, daysCounted = 0;
      document.querySelectorAll('#tabelaValores tbody tr').forEach(tr => {
        if (tr.style.display==='none') return;
        const rowStart = parseDateDMY(tr.cells[0].textContent);
        const rowEnd   = parseDateDMY(tr.cells[1].textContent);
        if (!rowStart || !rowEnd) return;

        const price    = parseFloat(tr.cells[2].textContent);
        const start    = ci  > rowStart ? ci  : rowStart;
        const end      = co  < rowEnd   ? co  : rowEnd;
        const overlap  = (end - start)/(1000*60*60*24);
        
        if (overlap > 0) {
          weightedSum += price * overlap;
          daysCounted += overlap;
        }
      });

      const avgPrice = (daysCounted > 0) ? weightedSum / daysCounted : 0;
      const desconto = parseFloat(document.getElementById('desconto').value)/100;
      const sinal = parseFloat(document.getElementById('sinal').value);
      const pessoas  = parseInt(document.getElementById('pessoas').value,10);
      const cotacoes  = await obterCotacoes();

      const bruto    = avgPrice * totalNights;
      const valorDesc= bruto * desconto;
      const liquido  = bruto - valorDesc;

      let totalTaxas = 0;
      const taxasDesc = [];
      document.querySelectorAll('#taxasAdicionaisContainer .input-group').forEach(taxaRow => {
          const desc = taxaRow.children[0].value || 'Taxa Adicional';
          const valor = parseFloat(taxaRow.children[1].value) || 0;
          if (valor > 0) {
              totalTaxas += valor;
              taxasDesc.push({descricao: desc, valor: valor});
          }
      });
      
      const totalGeral = liquido + totalTaxas;
      const valorSinal = totalGeral * (sinal / 100);
      const valorRestante = totalGeral - valorSinal;
      const diariaMediaFinal = totalGeral / totalNights;
      
      const dados = { totalNights, avgPrice, pessoas, diariaMediaFinal };
      const valores = { bruto, valorDesc, liquido, totalTaxas, taxasDesc, totalGeral, valorSinal, valorRestante, sinal };

      propostaAtual = {
          cliente: document.getElementById('nome').value,
          contato: document.getElementById('contato').value,
          checkin: new Date(document.getElementById('checkin').value).toLocaleDateString('pt-BR', { timeZone: 'UTC' }),
          checkout: new Date(document.getElementById('checkout').value).toLocaleDateString('pt-BR', { timeZone: 'UTC' }),
          totalNights: dados.totalNights,
          diariaMediaFinal: dados.diariaMediaFinal,
          totalGeral: valores.totalGeral,
          valorSinal: valores.valorSinal
      };

      gerarRelatorioHtml(valores, dados, cotacoes);
    }
    
    function gerarRelatorioHtml(valores, dados, cotacoes) {
        const clienteNome = document.getElementById('nome').value;
        const checkin = new Date(document.getElementById('checkin').value).toLocaleDateString('pt-BR', {timeZone: 'UTC'});
        const checkout = new Date(document.getElementById('checkout').value).toLocaleDateString('pt-BR', {timeZone: 'UTC'});
        
        let taxasHtml = '';
        if (valores.taxasDesc.length > 0) {
            valores.taxasDesc.forEach(t => {
                taxasHtml += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>${t.descricao}</span>
                        <span class="text-success">+ R$ ${t.valor.toFixed(2)}</span>
                    </li>
                `;
            });
        }

        const hoje = new Date().toLocaleDateString('pt-BR');

        const html = `
        <div class="card" id="relatorio">
            <div class="card-header bg-dark text-white">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">Proposta de Reserva</h4>
                        <span>Para: <strong>${clienteNome}</strong></span>
                    </div>
                    <div class="text-end">
                        <img src="https://via.placeholder.com/150x50.png?text=SUA+LOGO" alt="Logo" style="height: 40px;">
                        <p class="mb-0 mt-1" style="font-size: 0.8rem;">Data: ${hoje}</p>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-4">
                        <strong>Check-in:</strong> ${checkin}
                    </div>
                    <div class="col-md-4">
                        <strong>Check-out:</strong> ${checkout}
                    </div>
                    <div class="col-md-4">
                        <strong>Total de Noites:</strong> ${dados.totalNights}
                    </div>
                     <div class="col-md-12 mt-2">
                        <strong class="text-primary h5">Valor da Di√°ria M√©dia: R$ ${dados.diariaMediaFinal.toFixed(2)}</strong>
                    </div>
                </div>

                <h5 class="card-title">Detalhamento de Valores</h5>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>Valor bruto (${dados.totalNights} noites x R$ ${dados.avgPrice.toFixed(2)} em m√©dia)</span>
                        <span>R$ ${valores.bruto.toFixed(2)}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>Desconto (${(document.getElementById('desconto').value)}%)</span>
                        <span class="text-danger">- R$ ${valores.valorDesc.toFixed(2)}</span>
                    </li>
                    ${taxasHtml}
                    <li class="list-group-item d-flex justify-content-between align-items-center bg-light">
                        <strong class="h5">TOTAL GERAL (BRL)</strong>
                        <strong class="h5">R$ ${valores.totalGeral.toFixed(2)}</strong>
                    </li>
                </ul>

                <div class="row mt-4 p-3 bg-light rounded">
                    <div class="col-md-6">
                        <h6>Valores em Outras Moedas (Cota√ß√£o do dia)</h6>
                        <p class="mb-1">Total em D√≥lar (USD): <strong>$ ${(valores.totalGeral / cotacoes.BRL).toFixed(2)}</strong> <small class="text-muted">(cota√ß√£o ~R$ ${cotacoes.BRL.toFixed(2)})</small></p>
                        <p class="mb-0">Total em Pesos (ARS): <strong>$ ${(valores.totalGeral / cotacoes.BRL * cotacoes.ARS).toFixed(2)}</strong> <small class="text-muted">(cota√ß√£o ~ARS ${cotacoes.ARS.toFixed(2)} por USD)</small></p>
                    </div>
                    <div class="col-md-6 border-start">
                         <h6>Condi√ß√µes de Pagamento</h6>
                         <p class="mb-1">Sinal para reserva (${valores.sinal}%): <strong>R$ ${valores.valorSinal.toFixed(2)}</strong></p>
                         <p class="mb-0">Restante no check-in: <strong>R$ ${valores.valorRestante.toFixed(2)}</strong></p>
                    </div>
                </div>
            </div>
            <div class="card-footer text-muted text-center">
                <p class="mb-1">Esta √© uma proposta v√°lida por 48 horas. A reserva √© confirmada mediante pagamento do sinal.</p>
                <p class="mb-0"><strong>Seu Contato:</strong> (XX) XXXXX-XXXX | seuemail@provedor.com</p>
                <div class="mt-2">
                    <button class="btn btn-sm btn-success" onclick="enviarPropostaWhatsApp()"><i class="bi bi-whatsapp"></i> Enviar via WhatsApp</button>
                    <button class="btn btn-sm btn-primary" onclick="salvarRelatorioComoHtml()"><i class="bi bi-file-earmark-arrow-down"></i> Salvar Proposta</button>
                    <button class="btn btn-sm btn-secondary" onclick="imprimirRelatorio()"><i class="bi bi-printer"></i> Imprimir</button>
                </div>
            </div>
        </div>
        `;
        document.getElementById('relatorioContainer').innerHTML = html;
        document.getElementById('relatorioContainer').scrollIntoView({ behavior: 'smooth' });
    }

    function salvarTabelaLocal() {
        const status = document.getElementById('statusSalvo');
        status.textContent = 'Salvando...';
        status.className = 'badge bg-warning text-dark';
        status.style.display = 'inline';

        const linhas = Array.from(document.querySelectorAll('#tabelaValores tbody tr')).map(tr =>
            Array.from(tr.cells).slice(0, 7).map(td => td.textContent)
        );
        localStorage.setItem('tabelaValores', JSON.stringify(linhas));

        setTimeout(() => {
            status.textContent = 'Salvo!';
            status.className = 'badge bg-success';
            setTimeout(() => {
                status.style.display = 'none';
            }, 1500);
        }, 200);
    }

    function adicionarLinha() {
        const tabela = document.querySelector('#tabelaValores tbody');
        const novaLinha = document.createElement('tr');
        const campos = ['dd/mm/aaaa', 'dd/mm/aaaa', '0', '0', '1', 'Baixa', 'Nova Tarifa'];
        
        campos.forEach(valor => {
            const td = document.createElement('td');
            td.contentEditable = true;
            td.textContent = valor;
            novaLinha.appendChild(td);
        });

        const tdRemover = document.createElement('td');
        const btnRemover = document.createElement('button');
        btnRemover.className = 'btn btn-sm btn-danger';
        btnRemover.innerHTML = '<i class="bi bi-trash"></i>';
        btnRemover.title = 'Remover linha';
        btnRemover.addEventListener('click', () => {
            novaLinha.remove();
            salvarTabelaLocal();
        });
        tdRemover.appendChild(btnRemover);
        novaLinha.appendChild(tdRemover);

        tabela.appendChild(novaLinha);
        salvarTabelaLocal();
    }
    
    function exportarJson() {
        const dados = JSON.parse(localStorage.getItem('tabelaValores'));
        const blob = new Blob([JSON.stringify(dados, null, 2)], { type: 'application/json' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'tarifas_hospedagem.json';
        link.click();
    }
    
    function importarJson(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const dados = JSON.parse(e.target.result);
                const tabela = document.querySelector('#tabelaValores tbody');
                tabela.innerHTML = '';
                dados.forEach(campo => {
                    const tr = document.createElement('tr');
                    campo.forEach(valor => {
                        const td = document.createElement('td');
                        td.contentEditable = true;
                        td.textContent = valor;
                        tr.appendChild(td);
                    });
                    const tdRemover = document.createElement('td');
                    const btnRemover = document.createElement('button');
                    btnRemover.className = 'btn btn-sm btn-danger';
                    btnRemover.innerHTML = '<i class="bi bi-trash"></i>';
                    btnRemover.title = 'Remover linha';
                    btnRemover.addEventListener('click', () => {
                        tr.remove();
                        salvarTabelaLocal();
                    });
                    tdRemover.appendChild(btnRemover);
                    tr.appendChild(tdRemover);
                    tabela.appendChild(tr);
                });
                salvarTabelaLocal();
            } catch (err) {
                alert('Erro ao importar JSON: formato inv√°lido.');
            }
        };
        reader.readAsText(file);
    }
    
    function salvarRelatorioComoHtml() {
        const relatorioHtml = document.getElementById('relatorio').outerHTML;
        const fullHtml = `<!DOCTYPE html><html lang="pt-BR"><head><meta charset="UTF-8"><title>Proposta de Reserva</title><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"></head><body class="bg-light"><div class="container mt-5">${relatorioHtml}</div></body></html>`;
        const blob = new Blob([fullHtml], { type:'text/html;charset=utf-8' });
        const nome = document.getElementById('nome').value.replace(/\s+/g,'_');
        const hoje = new Date().toISOString().slice(0,10);
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `Proposta_${nome}_${hoje}.html`;
        link.click();
    }
    
    function imprimirRelatorio() {
        const relatorioHtml = document.getElementById('relatorio').innerHTML;
        const originalPage = document.body.innerHTML;
        document.body.innerHTML = `<div class="container mt-5">${relatorioHtml}</div>`;
        window.print();
        document.body.innerHTML = originalPage;
        location.reload();
    }

    function enviarPropostaWhatsApp() {
        if (!propostaAtual.cliente) {
            alert('Por favor, calcule um or√ßamento primeiro.');
            return;
        }

        const telefone = propostaAtual.contato.replace(/\D/g, '');
        if (telefone.length < 10) {
            alert('O n√∫mero de contato parece inv√°lido. Verifique se ele cont√©m o c√≥digo do pa√≠s e o DDD.');
            return;
        }

        const mensagem = `Ol√°, ${propostaAtual.cliente}! üëã\n\n` +
            `Segue a sua simula√ß√£o de reserva:\n\n` +
            `üóìÔ∏è *Check-in:* ${propostaAtual.checkin}\n` +
            `üóìÔ∏è *Check-out:* ${propostaAtual.checkout}\n` +
            `üåô *Total de noites:* ${propostaAtual.totalNights}\n\n` +
            `üíµ *Valor da di√°ria m√©dia:* R$ ${propostaAtual.diariaMediaFinal.toFixed(2)}\n` +
            `üí∞ *VALOR TOTAL:* R$ ${propostaAtual.totalGeral.toFixed(2)}\n\n` +
            `Para confirmar sua reserva, o sinal √© de R$ ${propostaAtual.valorSinal.toFixed(2)}.\n\n` +
            `Aguardo seu retorno!`;
        
        const mensagemCodificada = encodeURIComponent(mensagem);
        const urlWhatsApp = `https://wa.me/${telefone}?text=${mensagemCodificada}`;
        
        window.open(urlWhatsApp, '_blank');
    }
  </script>
</body>
</html>